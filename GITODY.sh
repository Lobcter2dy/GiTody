#!/bin/bash

# [Module:Launcher] GiTody Unified Runner
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞ (–≤–∞–∂–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º)
cd "$(dirname "$0")" || exit 1

echo "------------------------------------------"
echo "üöÄ GiTody Launcher"
echo "------------------------------------------"

# 1. –ñ–µ—Å—Ç–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
echo "[1/3] –û—á–∏—Å—Ç–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
# –£–±–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å—ã —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –¥—Ä—É–≥–∏–º
pkill -f "electron . --dev" 2>/dev/null
pkill -f "electron . --no-sandbox" 2>/dev/null
# –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç—ã (47523 - —Å–µ—Ä–≤–µ—Ä, 47524 - oauth)
fuser -k 47523/tcp 2>/dev/null
fuser -k 47524/tcp 2>/dev/null

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ node_modules
if [ ! -d "node_modules" ]; then
    echo "[2/3] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫)..."
    npm install
else
    echo "[2/3] –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞–π–¥–µ–Ω—ã."
fi

# 3. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "[3/3] –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ Electron..."
# –ö–†–ò–¢–ò–ß–ù–û: –û—Ç–∫–ª—é—á–∞–µ–º sandbox —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Ä–µ—à–∞–µ—Ç SIGTRAP –Ω–∞ Linux)
export ELECTRON_DISABLE_SANDBOX=1
export BROWSER=none

# –°–æ–±–∏—Ä–∞–µ–º production –±–∏–ª–¥ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º Electron
npm run build
./node_modules/electron/dist/electron . --no-sandbox || {
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ."
    echo "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞..."
    read -r
}

